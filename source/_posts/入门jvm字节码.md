---
title: 入门jvm字节码
date: 2024-07-29 17:22:35
tags:
    - Coding
    - Java
---

java是很简单的，但是这背后支撑着java的是什么？
<!--more-->
# 引言
jvm是一台虚拟机，能够执行java字节码，也就是java的汇编。

本篇文章将避免涉及具体的指令，从了解的程度来描述java字节码设计。



# 虚拟机结构

## 重点内容
对于每一个`class`，有一个常量池、静态变量表

对于每一个实例对象，有一个成员变量表

对于每一个`function`，有一个局部变量表、一个操作数堆栈

## 与8086汇编的区别

1. 弃用了标志位、寄存器
2. java字节码属于精简指令集，8086汇编属于复杂指令集
3. 引入了局部变量表、常量池
4. java字节码更高级，难以使用逻辑电路实现
   - 异常处理
   - 字节码级别的面向对象
   - 字节码级别的多线程锁
   - 自动管理的函数调用（传参、返回）
   - 还隐含了runtime与jvm之间的各种操作，例如
     - 自动内存管理
     - 动态加载、反射

## 优势与代价
作为高级汇编，优势有
- 是一个抽象层，模糊了不同架构CPU之间的差异，易于跨平台
- 在汇编层面实现了面向对象支持，提高了简便性

但同时也有缺陷
- 增加了抽象、面向对象、runtime的代价
- 简便性的同时也意味着失去了灵活性，使得java难以在编译的时候进行优化（字节码层面的优化），各项优化高度依赖运行时

# 助记符/伪码

详细的内容请参阅[这些文章](#reference)

# 函数传参
之所以要先讲函数传参方式，是因为java字节码的许多指令也都是以这种方式工作的（类似于调用函数）。

均采用堆栈的方式传参。

由于jvm知道目标函数需要什么，返回什么，

1. 自动从操作数堆栈上（从栈顶开始）弹出对应的参数。（当然你得先把这些相应的参数放在操作数堆栈上）
2. 传入目标函数（的局部变量表）
3. 目标函数执行
4. 目标函数返回栈顶元素（目标函数的操作数堆栈），传到调用者的堆栈上。（如果无返回值，那么就没有这一步）

示意图如下，表示调用者的操作数堆栈

|调用者的操作数堆栈(调用前)|
|:---:|
|12|
|11|

目标函数
```java
static int getMax(int a,int b){
    return a>b?a:b;
}
```
|调用者的操作数堆栈(调用后)|
|:---:|
|12|


### 非静态函数调用
这里可以提一嘴非静态函数的调用，在Python中，一个类的非静态函数我们通常定义如下：
```python
def not_static_function(self,parameter):
    pass
```
其实在java中本质也是一样的，调用非静态方法时会传入this参数（并且也是第一个参数）

# 算数

就像函数调用一样，调用Java的算数指令时会从堆栈上弹出相应操作数（一个或两个），然后将计算结果压入堆栈。

java在字节码级别支持一下运算：
加法指令
减法指令
乘法指令
除法指令
求余指令
自增指令


# 分支结构/跳转
虽然jvm没有标志位这一设计，但仍能够进行条件跳转。

在java字节码级别有两个方法

## 先比较再跳转（形如8086汇编中的CMP & Jxx）
java字节码有一系列很神奇的指令，这玩意传参类似于函数调用，能够弹出堆栈上的栈顶两个元素进行比较，然后将比较结果（1、0、-1）压入堆栈。

然后再调用各种条件跳转指令，即可跳转到指定位置。

## 比较并跳转
直接比较栈顶的两个元素，如果符合条件就跳转

# 异常处理
其实java的异常处理核心并不是放在可执行字节码里面的，而是对函数的一个标注。

大致如下，表示在0~4的字节码执行过程中若发生了`java/lang/ArithmeticException`异常，那么跳转到地7个字节码的位置
|From|To|Target|Type
|:---:|:---:|:---:|:---|
|0|4|7|Class java/lang/ArithmeticException

# 为何要了解java字节码

其实java runtime已经几乎完成了所有背后的工作，如果你不用接触底层的原理，emm，也没有多大必要学java字节码。

~~我是觉得好玩才学的~~



# Reference

- [Java 字节码技术：不积细流，无以成江河](https://learn.lianglianglee.com/%e4%b8%93%e6%a0%8f/JVM%20%e6%a0%b8%e5%bf%83%e6%8a%80%e6%9c%af%2032%20%e8%ae%b2%ef%bc%88%e5%ae%8c%ef%bc%89/05%20Java%20%e5%ad%97%e8%8a%82%e7%a0%81%e6%8a%80%e6%9c%af%ef%bc%9a%e4%b8%8d%e7%a7%af%e7%bb%86%e6%b5%81%ef%bc%8c%e6%97%a0%e4%bb%a5%e6%88%90%e6%b1%9f%e6%b2%b3.md)
- [Java字节码指令详解，1 万字20 张图带你彻底掌握字节码指令](https://javabetter.cn/jvm/zijiema-zhiling.html)
- [Java Virtual Machine Specification](https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html)